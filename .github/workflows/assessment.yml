name: Run Assessment
on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  assess:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull Docker images
        run: |
          # Pull v5 image (CSV embedded in text as JSON)
          docker pull ghcr.io/nprakash-star/meta-ml-green:v5
          docker tag ghcr.io/nprakash-star/meta-ml-green:v5 ghcr.io/nprakash-star/meta-ml-green:latest
          docker pull ghcr.io/nprakash-star/meta-ml-solver:latest
      
      - name: Create Docker network
        run: docker network create assessment-network
      
      - name: Start Purple Agent (Solver)
        run: |
          docker run -d \
            --name solver \
            --network assessment-network \
            -p 9009:9009 \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            ghcr.io/nprakash-star/meta-ml-solver:latest
          echo "Waiting for solver to start..."
          sleep 15
      
      - name: Test solver agent
        run: |
          curl -f http://localhost:9009/ || echo "Solver health check failed"
      
      - name: Start Green Agent (Evaluator)
        run: |
          docker run -d \
            --name green-agent \
            --network assessment-network \
            -p 9010:9009 \
            -e AGENT_URL="http://localhost:9010/" \
            ghcr.io/nprakash-star/meta-ml-green:latest
          echo "Waiting for green agent to start..."
          sleep 10
      
      - name: Install A2A SDK
        run: |
          pip install httpx "a2a-sdk[http-server]"
      
      - name: Run Assessment via A2A Protocol
        id: assessment
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p results
          
          # Make script executable
          chmod +x .github/workflows/run_assessment.py
          
          # Show what image version green agent is using
          echo "=== GREEN AGENT STARTUP ==="
          docker logs green-agent 2>&1 | head -20 || true
          
          # Run assessment using Python A2A SDK (save exit code)
          set +e
          python3 .github/workflows/run_assessment.py results/result_${TIMESTAMP}.json
          EXIT_CODE=$?
          set -e
          
          # Always show logs
          echo "=== GREEN AGENT FULL LOGS ==="
          docker logs green-agent 2>&1
          echo "=== SOLVER FULL LOGS ==="
          docker logs solver 2>&1
          
          # Exit with original code
          exit $EXIT_CODE
          
          # Replace placeholders in result file
          sed -i "s/\${GITHUB_SHA}/${{ github.sha }}/g" results/result_${TIMESTAMP}.json
          sed -i "s/\${GITHUB_RUN_ID}/${{ github.run_id }}/g" results/result_${TIMESTAMP}.json
          
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
      
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add results/
          git diff --staged --quiet || git commit -m "Add assessment results for run ${{ github.run_number }} [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assessment-results-${{ github.run_number }}
          path: results/
      
      - name: Cleanup
        if: always()
        run: |
          docker stop solver || true
          docker rm solver || true
          docker network rm assessment-network || true
